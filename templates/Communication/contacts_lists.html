{% extends 'base.html' %}
{% block title %}
Communication Dashboard
{% endblock title %}

{% block content %}
{% load static %}
{% load custom_filters %}
<link href="{% static 'css/surplusindex.css' %}" rel="stylesheet">

<div class="section-header">
    <h4>Contact Lists</h4>
</div>
<div class="section-body-full">

</div>
</br>
<div class="section-header">
    <h4>Client Contacts</h4>
    <a href="{% url 'client_contacts' %}" class="button">Clear All</a>
</div>
<div class="section-body-full">
    <div class="onehalf">
    <form method="POST" action="{% url 'update_client_contacts' %}">
    {% csrf_token %}
        <input type="hidden" name="contact_id" value="{{contact_instance.id}}">
        <div class="form-row">
            <label for="name">Name</label>
            <input type="text" name="name" id="name" {% if contact_instance and contact_instance.name %}value="{{contact_instance.name}}"{% endif %}>
        </div>
        <div class="form-row">
            <label for="email">Email</label>
            <input type="text" name="email" id="email" {% if contact_instance and contact_instance.email %}value="{{contact_instance.email}}"{% endif %}>
        </div>
        <div class="form-row">
            <label for="phone">Phone</label>
            <input type="text" name="phone" id="phone" {% if contact_instance and contact_instance.phone %}value="{{contact_instance.phone}}"{% endif %}>
        </div>
        <div class="form-row">
            <label for="business_name">Business Name</label>
            <input type="text" name="business_name" id="business_name" {% if contact_instance and contact_instance.business_name %}value="{{contact_instance.business_name}}"{% endif %}>
        </div>
        <div class="form-row">
            <label for="address">Address</label>
            <input type="text" name="address" id="address" {% if contact_instance and contact_instance.address %}value="{{contact_instance.address}}"{% endif %}>
        </div>
        <input type="submit" class="button" value="{% if contact_instance %}Update Contact{% else %}Create Contact{% endif %}">
    </form>
    </div>
    <div class="onehalf">
    <label>Preferred States</label>
    <div style="display:flex; gap:10px; align-items:center; padding:0px 50px;">
        
        <!-- Available States -->
        <select id="available_states" multiple size="10" style="min-width:200px;">
            {% for state in all_states %}
                {% if state not in contact_instance.preferred_states.all %}
                    <option value="{{ state.id }}">{{ state.name }}</option>
                {% endif %}
            {% endfor %}
        </select>

        <!-- Buttons -->
        <div style="display:flex; flex-direction:column; gap:10px;">
            <button type="button" id="add_btn">&gt;&gt;</button>
            <button type="button" id="remove_btn">&lt;&lt;</button>
        </div>

        <!-- Preferred States -->
        <select id="preferred_states" multiple size="10" style="min-width:200px;">
            {% for state in contact_instance.preferred_states.all %}
                <option value="{{ state.id }}">{{ state.name }}</option>
            {% endfor %}
        </select>
    </div>    
    </div>
    <div class="table-wrapper">
        <table class="table table-striped table-hover" style="margin-top:30px;">
            <thead>
                <tr>
                    <th>Client Name</th>
                    <th>Email Address</th>
                    <th>Contact Number</th>
                    <th>Business Name / Address</th>
                    <th>Edit</th>
                </tr>
            </thead>
            <tbody>
            {% for contact in contacts %}
                <tr>
                    <td>{{contact.name}}</td>
                    <td>{{contact.email}}</td>
                    <td>{{contact.phone}}</td>
                    <td>{% if contact.business_name %}<small>{{contact.business_name}}</br>{{contact.address}}</small>{% else %}{{contact.address}}{% endif %}</td>
                    <td>
                    <form method="POST" action="{% url 'client_contacts' %}">
                    {% csrf_token %}
                        <input type="hidden" name="contact_id" value={{contact.id}}>
                        <input type="submit" class="button" value="Edit">
                    </form>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<script>
function moveOptions(fromId, toId, action) {
    let from = document.getElementById(fromId);
    let to = document.getElementById(toId);

    let selectedIds = [];
    Array.from(from.selectedOptions).forEach(option => {
        to.appendChild(option);
        selectedIds.push(option.value);
    });

    if (selectedIds.length > 0) {
        updatePreferredStates(selectedIds, action);
    }
}

// AJAX call
function updatePreferredStates(stateIds, action) {
    fetch(`/client_contacts/{{ contact_instance.id }}/update_preferred_states/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify({
            state_ids: stateIds,
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log("Updated:", data);
    })
    .catch(error => console.error("Error:", error));
}

document.getElementById("add_btn").addEventListener("click", function() {
    moveOptions("available_states", "preferred_states", "add");
});

document.getElementById("remove_btn").addEventListener("click", function() {
    moveOptions("preferred_states", "available_states", "remove");
});
</script>

{% endblock content %}