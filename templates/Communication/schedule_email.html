{% extends "base.html" %}

{% block content %}
<h2>Schedule or Send Email</h2>

<form method="post" action="">
  {% csrf_token %}

  <!-- Sender account -->
  <label for="sender">Sender:</label>
  <select name="sender" id="sender" required>
    {% for account in mail_accounts %}
      <option value="{{ account.id }}">{{ account.name }} ({{ account.email }})</option>
    {% endfor %}
  </select>
  <br><br>

  <!-- Scope: single or multiple -->
  <label>Recipient Type:</label>
  <select name="scope" id="scope" onchange="toggleRecipientFields()" required>
    <option value="single">Single Recipient</option>
    <option value="multiple">Multiple Recipients</option>
  </select>
  <br><br>

  <!-- Single recipient -->
  <div id="single-field">
    <label for="recipient">Recipient Email:</label>
    <input type="email" name="recipient" id="recipient">
  </div>

  <!-- Multiple recipients -->
  <div id="multiple-fields" style="display:none;">
    <label for="recipients_list">Multiple Emails (comma separated):</label><br>
    <textarea name="recipients_list" id="recipients_list" rows="3"></textarea><br><br>

    <label for="contact_list">Or select Contact List:</label>
    <select name="contact_list" id="contact_list">
      <option value="">-- None --</option>
      {% for clist in contact_lists %}
        <option value="{{ clist.id }}">{{ clist.name }}</option>
      {% endfor %}
    </select>
  </div>
  <br>

  <!-- Template -->
  <label for="template">Template:</label>
  <select name="template" id="template" onchange="fillTemplate()">
    <option value="">-- None --</option>
    {% for tmpl in templates %}
      <option value="{{ tmpl.id }}"
              data-subject="{{ tmpl.subject|escapejs }}"
              data-body="{{ tmpl.body|escapejs }}"
              data-signature="{{ tmpl.signature|escapejs }}">
        {{ tmpl.name }}
      </option>
    {% endfor %}
  </select>
  <br><br>

  <!-- Subject & Body -->
  <label for="custom_subject">Subject:</label>
  <input type="text" name="custom_subject" id="custom_subject"><br><br>

  <label for="custom_body">Body:</label><br>
  <textarea name="custom_body" id="custom_body" rows="6"></textarea>
  <br><br>

  <!-- Schedule -->
  <label for="send_time">Send Time:</label>
  <input type="datetime-local" name="send_time" id="send_time" required>
  <br><br>

  <button type="submit">Send / Schedule</button>
</form>

<script>
function toggleRecipientFields() {
  let scope = document.getElementById("scope").value;
  document.getElementById("single-field").style.display = (scope === "single") ? "block" : "none";
  document.getElementById("multiple-fields").style.display = (scope === "multiple") ? "block" : "none";
}

function fillTemplate() {
  let select = document.getElementById("template");
  let option = select.options[select.selectedIndex];
  let subject = option.getAttribute("data-subject");
  let body = option.getAttribute("data-body");
  let signature = option.getAttribute("data-signature");

  if (subject) document.getElementById("custom_subject").value = subject;
  if (body) document.getElementById("custom_body").value = body + "\n\n" + (signature || "");
}
</script>
{% endblock %}
