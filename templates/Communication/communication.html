{% extends 'base.html' %}
{% block title %}
Communication Dashboard
{% endblock title %}

{% block content %}
{% load static %}
{% load custom_filters %}
<link href="{% static 'css/surplusindex.css' %}" rel="stylesheet">

<div class="section-header">
    <h4>Send or Schedule Email</h4>
</div>
<div class="section-body-full">
    <form method="post" action="{% url 'schedule_email' %}">
    {% csrf_token %}
    <div class="onehalf">
        <div class="form-row">
            <!-- Select Mail Account -->
            <label for="sender">From:</label>
            <select name="sender" required>
                {% for account in mail_accounts %}
                <option value="{{ account.id }}">{{ account.email_address }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-row">
            <!-- Recipient Scope -->
            <label for="scope">Recipient Type:</label>
            <select name="scope" id="scope" onchange="toggleScope()">
                <option value="single">Single</option>
                <option value="multiple">Multiple</option>
            </select>
        </div>

        <!-- Single Recipient -->
        <div id="singleRecipient" class="form-row">
            <label>Email:</label>
            <input type="email" name="recipient">
        </div>

        
        <!-- Multiple Recipients -->
        <div id="multipleRecipients" style="display:none;">
            <div class="form-row">
                <label>From Contact List:</label>
                <select name="contact_list">
                    <option value="">--None--</option>
                    <option value="all-clients">All Clients</option>
                    {% for cl in contact_lists %}
                    <option value="{{ cl.id }}">{{ cl.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-row">
                <label>Or Enter Emails:</label>
                <textarea name="recipients_list" rows="3" placeholder=" Comma Separated "></textarea>
            </div>
        </div>
        <div class="form-row">
            <!-- Template -->
            <label for="template">Choose Template:</label>
            <select name="template" id="template" onchange="loadTemplate()">
                <option value="">--None--</option>
                {% for t in templates %}
                <option value="{{ t.id }}" data-subject="{{ t.subject }}" data-body="{{ t.body }} {{ t.signature|default:'' }}">{{ t.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-row">
            <!-- Send Mode -->
            <label for="send_mode">Send Mode:</label>
            <select name="send_mode" id="send_mode" onchange="toggleSchedule()">
                <option value="now">Send Now</option>
                <option value="later">Schedule</option>
            </select>
        </div>
        <!-- Schedule Time Picker -->
        <div id="scheduleTime" style="display:none;">
            <div class="form-row">
                <label for="send_time">Schedule Time:</label>
                <input type="datetime-local" name="send_time">
            </div>
        </div>
        <button type="submit" class="button" style="width:95%">Submit</button>
    </div>
    <div class="onehalf table-wrapper">
        <div style="text-align-last:left;">
        <!-- Subject + Body -->
        <label style="text-align:left">Subject:</label></br>
        <input type="text" name="custom_subject" id="subject" style="width:100%"></br></br>
    
        <label style="text-align:left">Mail Body:</label></br>
        <textarea name="custom_body" id="body" rows="10" style="width:100%; padding:3px;"></textarea>
        </div>
    </div>
        
    </form>
</div>


<script>
function toggleScope() {
    const scope = document.getElementById("scope").value;
    document.getElementById("singleRecipient").style.display = scope === "single" ? "block" : "none";
    document.getElementById("multipleRecipients").style.display = scope === "multiple" ? "block" : "none";
    }

function toggleSchedule() {
    const mode = document.getElementById("send_mode").value;
    document.getElementById("scheduleTime").style.display = mode === "later" ? "block" : "none";
    }

function loadTemplate() {
    const select = document.getElementById("template");
    const selected = select.options[select.selectedIndex];
    const subject = selected.getAttribute("data-subject");
    const body = selected.getAttribute("data-body");

    if (subject) document.getElementById("subject").value = subject;
    if (body) document.getElementById("body").value = body;
    }
</script>

<script src="{% static 'js/Surplusindex.js' %}"></script>
{% endblock content %}