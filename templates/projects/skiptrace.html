{% extends 'base.html' %}
{% block title %}
Skiptracing
{% endblock title %}


{% block content %}
{% load static %}
<link href="{% static 'css/surplusindex.css' %}" rel="stylesheet">
<link href="{% static 'css/nouislider.min.css' %}" rel="stylesheet">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

<!--Foreclosure Section               End -->
<div style="margin-top: 20px;" class="body-section">
    <div class="section-header" {% if current_con_instance and current_con_instance.skiptraced == True %}style="background-color: #bce376; color: #101010;"{% endif %}>
        {% if contact_selected == "" %}
        <h4>Create Contact</h4>
        {% else %}
        <h4>Update Contact</h4>
        {% endif %}
        <div>
        {% if researcher %}
        <a class="headerbutton" href="{% url 'skiptracing_checklist' %}">Skiptracing Checklist</a>
        {% endif %}
        <a class="headerbutton" href="{% url 'skiptrace' %}">Create New Contact</a>
        {% if not related_contact %}
        <button class="button markas_notfound" onclick="markasNotfound(this)" value={{current_con_instance.pk}}>Mark as Not Found</button>
        {% endif %}
        </div>
    </div>
    <div class="section-body-full">
        <form method="post" action="{% url 'create_update_contact' %}">
            {% csrf_token %}
            <input type="hidden" name="con_id" value="{{ current_con_instance.pk }}">   
            <input type="hidden" name="related_contact" value="{{related_contact}}">
            <label>Contact Name</label><br>
            <input type="text" name="prefix" id="prefix" placeholder="Prefix" value="{{current_con_instance.name_prefix}}">
            <input type="text" name="f_name" id="f_name" placeholder="First Name" value="{{current_con_instance.first_name}}">
            <input type="text" name="m_name" id="m_name" placeholder="Middle Name" value="{{current_con_instance.middle_name}}">
            <input type="text" name="l_name" id="l_name" placeholder="Last Name" value="{{current_con_instance.last_name}}">
            <input type="text" name="suffix" id="suffix" placeholder="Suffix" value="{{current_con_instance.suffix}}"></br>
            <label>Business Name</label><br>
            <input type="text" style="width:600px;" name="b_name" id="b_name" placeholder="Business Name" value="{{current_con_instance.business_name}}">
            <input type="text" name="designation" id="b_desig" placeholder="Designation" value="{{current_con_instance.designation}}">              
            <input type="submit" style="margin-top:20px;" value="{% if contact_selected == "" %}Create Contact Instance{% else %}Update Contact{% endif %}">
        </form>
    </div>
    <div class="section-body-full">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Contact Name</th>
                    <th>Business Name</th>
                    <th>Mailing Address</th>
                    <th>Select</th>
                </tr>
            </thead>
            <tbody id="con-results">
            </tbody>
        </table>
    </div>
</div>
<script>
    $(document).ready(function () {
        // Function to fetch and update search results
        function conResults() {
            const prefix = $('#prefix').val();
            const fName = $('#f_name').val();
            const mName = $('#m_name').val();
            const lName = $('#l_name').val();
            const suffix = $('#suffix').val();
            const business = $('#b_name').val();
            const desig = $('#b_desig').val();

            $.ajax({
                url: "{% url 'filter-con' %}",
                data: {
                    prefix: prefix,
                    f_name: fName,
                    m_name: mName,
                    l_name: lName,
                    suffix: suffix,
                    b_name: business,
                    b_desig: desig,
                },
                success: function (data) {
                    const contact = data.contact;
                    const conresultcontainer = $('#con-results');
                    conresultcontainer.empty();

                    if (contact.length > 0) {
                        contact.forEach(contact => {
                            let mailingAddressesHtml = '';
                            if (contact.mailing_addresses.length > 0) {
                                mailingAddressesHtml = contact.mailing_addresses.join('<br>'); // Join addresses with <br> for display
                            } else {
                                mailingAddressesHtml = 'No Mailing Address';
                            }
                            conresultcontainer.append(`
                            <tr>
                                <td>${contact.name_prefix} ${contact.first_name} ${contact.middle_name} ${contact.last_name} ${contact.name_suffix}</td>
                                <td>${contact.business_name}</td>
                                <td>${mailingAddressesHtml}</td>
                                <td>
                                    <form method="get" action="{% url 'skiptrace' %}">
                                        <input type="hidden" name="con_id" value="${contact.id}">
                                        <input type="hidden" name="related_contact" value="{{ related_contact }}">
                                        <input type="submit" value="Edit">
                                    </form>
                                </td>
                            </tr>

                            `);
                        });
                    } else {
                        conresultcontainer.append('<tr><th colspan="4"><center>No Contact Record found</center></th></tr>');
                    }
                }
            });
        }
        // Trigger AJAX call on input change
        $('#prefix, #f_name, #m_name, #l_name, #suffix, #b_name, #b_desig',).on('input', conResults);
    });
</script>

<!--Foreclosure Section               End -->

<!--Mailing Address Section               Start -->
<div style="margin-top: 20px;" class="body-section">
    <div id="mailing_address" class="section-header" {% if current_con_instance and current_con_instance.skiptraced == True %}style="background-color: #bce376; color: #101010;"{% endif %}>
        <h4>Mailing Addresses</h4>
        <form method="post" action="{% url 'fetch_mailing_address' %}">
            {% csrf_token %}
            <input type="hidden" name="con_id" value="{{ current_con_instance.pk }}">
            <input type="hidden" name="related_contact" value="{{ related_contact }}">
            <td><input type="submit" value="Fetch Mailing Address"></td>
        </form>
    </div>

    <div class="section-body-full">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Copy</th>
                    <th>County</th>
                    <th>Parcel ID</th>
                    <th>House</th>
                    <th>Street</th>
                    <th>Type</th>
                    <th>Dir</th>
                    <th>A/U/B</th>
                    <th>Ext</th>
                    <th>City</th>
                    <th>State</th>
                    <th>Zip</th>
                    <th>Update</th>
                    <th>Delete</th>
                </tr>
            <thead>    
            <tbody>
                {% for prop in all_mailing %}
                <tr>
                    <form id="search-form" method="post" action="{% url 'update_contacts' %}">
                        {% csrf_token %}
                        <input type="hidden" name="con_id" value="{{ current_con_instance.pk }}">
                        <input type="hidden" name="related_contact" value="{{ related_contact }}">
                        <input type="hidden" name="propid" value="{{ prop.pk }}">
                        <td><input type="button" class="copyButton" value="Copy" data="{{prop.street_address|upper}}"onclick="copyToClipboard(this);"></td>
                        <td><input style="width: 120px; " type="text" id="county" placeholder="County" value="{{prop.county}}" name="county"></td>
                        <td><input style="width: 170px;" type="text" id="parcel" placeholder="Parcel" value="{{prop.parcel}}" name="parcel"></td>
                        <td><input style="width: 80px;" type="text" id="house" placeholder="House" value="{{prop.house_number}}" name="house"></td>
                        <td><input style="width: 150px;" type="text" id="street" placeholder="Street" value="{{prop.road_name}}" name="road"></td>
                        <td><input style="width: 70px;" type="text" id="sttype" placeholder="Type" value="{{prop.road_type}}" name="type"></td>
                        <td><input style="width: 70px;" type="text" id="dir" placeholder="Dir" value="{{prop.direction}}" name="dir"></td>
                        <td><input style="width: 70px;" type="text" id="apt" placeholder="A/B/U" value="{{prop.apt_unit}}" name="apt"></td>
                        <td><input style="width: 70px;" type="text" id="ext" placeholder="Ext" value="{{prop.extention}}" name="ext"></td>
                        <td><input style="width: 120px;" type="text" id="city" placeholder="City" value="{{prop.city}}" name="city"></td>
                        <td><input style="width: 120px;" type="text" id="state" placeholder="State" value="{{prop.state}}" name="state"></td>                      
                        <td><input style="width: 70px;" type="text" id="zip" placeholder="Zip" value="{{prop.zip_code}}" name="zip"></td>
                        <td><input type="submit" name="update" value="Update" ></td>
                        <td><input type="submit" name="delete" value="Delete" ></td>
                    </form>
                </tr>
                {% endfor %}
                <tr>
                    <form id="search-form" method="post" action="{% url 'search_create_property' %}">
                        {% csrf_token %}
                        <input type="hidden" name="con_id" value="{{ current_con_instance.pk }}">
                        <input type="hidden" name="related_contact" value="{{ related_contact }}">
                        <td></td>
                        <td><input style="width: 120px; border: 2px solid #08c88e; background-color: #54ff001f" type="text" id="icounty" placeholder="County" name="county"></td>
                        <td><input style="width: 170px; border: 2px solid #08c88e; background-color: #54ff001f" type="text" id="iparcel" placeholder="Parcel" name="parcel"></td>
                        <td><input style="width: 80px; border: 2px solid #08c88e; background-color: #54ff001f" type="text" id="ihouse" placeholder="House" name="house"></td>
                        <td><input style="width: 150px; border: 2px solid #08c88e; background-color: #54ff001f" type="text" id="istreet" placeholder="Street" name="road"></td>
                        <td><input style="width: 70px; border: 2px solid #08c88e; background-color: #54ff001f" type="text" id="isttype" placeholder="Type" name="type"></td>
                        <td><input style="width: 70px; border: 2px solid #08c88e; background-color: #54ff001f" type="text" id="idir" placeholder="Dir" name="dir"></td>
                        <td><input style="width: 70px; border: 2px solid #08c88e; background-color: #54ff001f" type="text" id="iapt" placeholder="A/B/U" name="apt"></td>
                        <td><input style="width: 70px; border: 2px solid #08c88e; background-color: #54ff001f" type="text" id="iext" placeholder="Ext" name="ext"></td>
                        <td><input style="width: 120px; border: 2px solid #08c88e; background-color: #54ff001f" type="text" id="icity" placeholder="City" name="city"></td>
                        <td><input style="width: 120px; border: 2px solid #08c88e; background-color: #54ff001f" type="text" id="istate" placeholder="State" name="state"></td>                      
                        <td><input style="width: 70px; border: 2px solid #08c88e; background-color: #54ff001f" type="text" id="izip" placeholder="Zip" name="zip"></td>
                        <td colspan="2"><input type="submit" style="border: 2px solid #08c88e;" Value="Create"></td>
                        
                    </form>
                </tr>
            </tbody>
            <tbody id="address-results">
            </tbody>
        </table>
    </div>
</div>


<script>
    $(document).ready(function () {
        // Function to fetch and update search results
        function fetchResults() {
            const parcel = $('#iparcel').val();
            const state = $('#istate').val();
            const county = $('#icounty').val();
            const house = $('#ihouse').val();
            const street = $('#istreet').val();
            const sttype = $('#isttype').val();

            $.ajax({
                url: "{% url 'ajax_search' %}",
                data: {
                    parcel: parcel,
                    state: state,
                    county: county,
                    house: house,
                    street: street,
                    sttype: sttype
                },
                success: function (data) {
                    const address = data.address;
                    const resultsContainer = $('#address-results');
                    const state_rc = $('#state_rc');
                    resultsContainer.empty();

                    if (address.length > 0) {
                        address.forEach(address => {
                            resultsContainer.append(`

                            <tr>
                                <td></td>
                                <td>${address.county}</td>
                                <td>${address.parcel}</td>
                                <td>${address.house_number}</td>
                                <td>${address.road_name}</td>
                                <td>${address.road_type}</td>
                                <td>${address.direction}</td>
                                <td>${address.apt_unit}</td>
                                <td>${address.extention}</td>
                                <td>${address.city}</td>
                                <td>${address.state}</td>
                                <td>${address.zip_code}</td>
                                <td colspan="2"> 
                                    <form method="post" action="{% url 'add_mailing'%}">
                                    {% csrf_token %}
                                    <input type="hidden" name="con_id" value="{{ current_con_instance.pk }}">
                                    <input type="hidden" name="related_contact" value="{{ related_contact }}">
                                    <input type="hidden" name="property_id" value="${address.id}">
                                    <input type="submit" value="Add" onclick="this.form.submit()">
                                    </form>
                                </td>
                                <td></td>
                            </tr>
                            
                                `);
                        });
                    } else {
                        resultsContainer.append('<tr><th colspan="12"><center>No Such Address Found!</center></th></tr>');
                    }
                }
            });
        }

        // Trigger AJAX call on input change
        $('#iparcel, #istate, #icounty, #ihouse, #istreet, #isttype').on('input', fetchResults);
    });
</script>

<!--Mailing Address Section               End -->


<!--Email section-start-->

<div style="margin-top:20px; width:33%; display:inline-block; vertical-align: top;">
    <div id="em" class="section-header" {% if current_con_instance and current_con_instance.skiptraced == True %}style="background-color: #bce376; color: #101010;"{% endif %}>
        <h4>Emails</h4>
        <input
            type="email"
            id="email-input"
            placeholder="Email (ctrl+e)"
            data-con-id="{{ current_con_instance.pk }}"
            onchange="saveEmail(this)"
            style="width:230px;border:2px solid #767776ff;"
        >
    </div>



    <div class="section-body-full" style="min-height:300px;">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Email Address</th>
                    <th>Update</th>
                    <th>Delete</th>
                </tr>
            </thead>

            <!-- existing emails -->
            <tbody id="email-table-body">
                {% for email in all_email %}
                <tr id="email-row-{{ email.id }}">
                    <td>
                        <input type="text"
                            value="{{ email.email_address }}"
                            style="width:155px!important;"
                            onblur="updateEmail({{ email.id }}, this)">
                    </td>
                    <td>
                        <button class="button"
                                onclick="updateEmail({{ email.id }}, this)">
                            Update
                        </button>
                    </td>
                    <td>
                        <button class="button"
                                onclick="deleteEmail({{ email.id }})">
                            Delete
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>

            <!-- search/add results like defendants -->
            <tbody id="email-results"></tbody>
        </table>
    </div>
</div>
<script>
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

function saveEmail(input) {
    const email = input.value.trim().toLowerCase();
    const conId = input.dataset.conId;
    if (!email) return;

    

    // ðŸŸ¡ saving indicator
    input.style.backgroundColor = "#fff3cd";

    fetch("{% url 'search_create_email' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({ email, con_id: conId })
    })
    .then(res => res.json())
    .then(data => {
        if (!data.success) return;

        input.style.backgroundColor = "#a1fcb6ff";

        addEmailRow(data);

        setTimeout(() => {
            input.value = "";
            input.style.backgroundColor = "";
            input.focus();
        }, 400);
    })
    .catch(() => {
        input.style.backgroundColor = "#f8d7da";
    });
}

function addEmailRow(data) {
    const tbody = document.getElementById("email-table-body");
    const rowId = `email-row-${data.id}`;

    if (document.getElementById(rowId)) {
        blinkRow(rowId);
        return;
    }

    const row = document.createElement("tr");
    row.id = rowId;

    row.innerHTML = `
        <td>
            <input type="text"
                   value="${data.email}"
                   style="width:155px!important;"
                   onblur="updateEmail(${data.id}, this)">
        </td>
        <td>
            <button class="button"
                    onclick="updateEmail(${data.id}, this)">
                Update
            </button>
        </td>
        <td>
            <button class="button"
                    onclick="deleteEmail(${data.id})">
                Delete
            </button>
        </td>
    `;

    tbody.appendChild(row);
    blinkRow(rowId);
}


function updateEmail(id, el) {
    const row = document.getElementById(`email-row-${id}`);
    const email = row.querySelector("input").value.trim().toLowerCase();

    row.style.backgroundColor = "#fff3cd";

    fetch("{% url 'update_email_ajax' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({ id, email })
    })
    .then(res => res.json())
    .then(data => {
        row.style.backgroundColor = data.success ? "#d4edda" : "#f8d7da";
        setTimeout(() => row.style.backgroundColor = "", 500);
    });
}

function deleteEmail(id) {
    if (!confirm("Delete this email?")) return;

    fetch("{% url 'delete_email_ajax' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({ id })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            document.getElementById(`email-row-${id}`).remove();
        }
    });
}

function blinkRow(id) {
    const row = document.getElementById(id);
    row.style.backgroundColor = "#ffaf53ff";
    setTimeout(() => row.style.backgroundColor = "", 600);
}

</script>

<!--Email section-end-->

<!--Wireless section-start-->
<div style="margin-top:20px; width:33%; display:inline-block; vertical-align: top;">
    <div id="em" class="section-header" {% if current_con_instance and current_con_instance.skiptraced == True %}style="background-color: #bce376; color: #101010;"{% endif %}>
        <h4>Wireless</h4>
        <input
            type="text"
            id="wireless-input"
            placeholder="Wireless (ctrl+p)"
            data-con-id="{{ current_con_instance.pk }}"
            onchange="saveWireless(this)"
            style="width:230px;border:2px solid #767776ff;"
        >
    </div>



    <div class="section-body-full" style="min-height:300px;">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Wireless Numbers</th>
                    <th>Update</th>
                    <th>Delete</th>
                </tr>
            </thead>

            <!-- existing emails -->
            <tbody id="wireless-table-body">
                {% for wireless in all_wireless %}
                <tr id="wireless-row-{{ wireless.id }}">
                    <td> 
                        <input type="text" value="{{ wireless.w_number }}" style="width:155px!important;" onchange="updateWireless({{ wireless.id }}, this)">
                    </td>
                    <td>
                        <button class="button" onclick="updateWireless({{ wireless.id }}, this)">Update</button>
                    </td>
                    <td>
                        <button class="button"onclick="deleteWireless({{ wireless.id }})">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>

            <!-- search/add results like defendants -->
            <tbody id="wireless-results"></tbody>
        </table>
    </div>
</div>
<script>

function saveWireless(input) {
    const wireless = input.value.trim();
    const conId = input.dataset.conId;
    if (!wireless) return;

    

    // ðŸŸ¡ saving indicator
    input.style.backgroundColor = "#fff3cd";

    fetch("{% url 'search_create_wireless' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({ wireless, con_id: conId })
    })
    .then(res => res.json())
    .then(data => {
        if (!data.success) return;

        input.style.backgroundColor = "#a1fcb6ff";

        addWirelessRow(data);

        setTimeout(() => {
            input.value = "";
            input.style.backgroundColor = "";
            input.focus();
        }, 400);
    })
    .catch(() => {
        input.style.backgroundColor = "#f8d7da";
    });
}

function addWirelessRow(data) {
    const tbody = document.getElementById("wireless-table-body");
    const rowId = `wireless-row-${data.id}`;

    if (document.getElementById(rowId)) {
        blinkRowWireless(rowId);
        return;
    }

    const row = document.createElement("tr");
    row.id = rowId;

    row.innerHTML = `
        <td>
            <input type="text"
                   value="${data.wireless}"
                   style="width:155px!important;"
                   onchange="updateWireless(${data.id}, this)">
        </td>
        <td>
            <button class="button"
                    onclick="updateWireless(${data.id}, this)">
                Update
            </button>
        </td>
        <td>
            <button class="button"
                    onclick="deleteWireless(${data.id})">
                Delete
            </button>
        </td>
    `;

    tbody.appendChild(row);
    blinkRowWireless(rowId);
}


function updateWireless(id, el) {
    const row = document.getElementById(`wireless-row-${id}`);
    const wireless = row.querySelector("input").value.trim()

    row.style.backgroundColor = "#fff3cd";

    fetch("{% url 'update_wireless_ajax' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({ id, wireless })
    })
    .then(res => res.json())
    .then(data => {
        row.style.backgroundColor = data.success ? "#d4edda" : "#f8d7da";
        setTimeout(() => row.style.backgroundColor = "", 500);
    });
}

function deleteWireless(id) {
    if (!confirm("Delete this wireless number?")) return;

    fetch("{% url 'delete_wireless_ajax' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({ id })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            document.getElementById(`wireless-row-${id}`).remove();
        }
    });
}

function blinkRowWireless(id) {
    const row = document.getElementById(id);
    row.style.backgroundColor = "#ffaf53ff";
    setTimeout(() => row.style.backgroundColor = "", 600);
}

</script>


<!-- =======================Landline section-start==================================== -->
<div style="margin-top:20px; width:33%; display:inline-block; vertical-align: top;">
    <div id="em" class="section-header" {% if current_con_instance and current_con_instance.skiptraced == True %}style="background-color: #bce376; color: #101010;"{% endif %}>
        <h4>Landline</h4>
        <input
            type="text"
            id="landline-input"
            placeholder="Landline (ctrl+l)"
            data-con-id="{{ current_con_instance.pk }}"
            onchange="saveLandline(this)"
            style="width:230px;border:2px solid #767776ff;"
        >
    </div>



    <div class="section-body-full" style="min-height:300px;">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Landline</th>
                    <th>Update</th>
                    <th>Delete</th>
                </tr>
            </thead>

            <!-- existing emails -->
            <tbody id="landline-table-body">
                {% for landline in all_landline %}
                <tr id="landline-row-{{ landline.id }}">
                    <td> 
                        <input style="width:155px!important;" type="text" value="{{ landline.l_number }}" onchange="updateLandline({{ landline.id }}, this)">
                    </td>
                    <td>
                        <button class="button" onclick="updateLandline({{ landline.id }}, this)">Update</button>
                    </td>
                    <td>
                        <button class="button" onclick="deleteLandline({{ landline.id }})">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>

            <!-- search/add results like defendants -->
            <tbody id="landline-results"></tbody>
        </table>
    </div>
</div>
<script>

function saveLandline(input) {
    const landline = input.value.trim();
    const conId = input.dataset.conId;
    if (!landline) return;

    

    // ðŸŸ¡ saving indicator
    input.style.backgroundColor = "#fff3cd";

    fetch("{% url 'search_create_landline' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({ landline, con_id: conId })
    })
    .then(res => res.json())
    .then(data => {
        if (!data.success) return;

        input.style.backgroundColor = "#a1fcb6ff";

        addLandlineRow(data);

        setTimeout(() => {
            input.value = "";
            input.style.backgroundColor = "";
            input.focus();
        }, 400);
    })
    .catch(() => {
        input.style.backgroundColor = "#f8d7da";
    });
}

function addLandlineRow(data) {
    const tbody = document.getElementById("landline-table-body");
    const rowId = `landline-row-${data.id}`;

    if (document.getElementById(rowId)) {
        blinkRowLandline(rowId);
        return;
    }

    const row = document.createElement("tr");
    row.id = rowId;

    row.innerHTML = `
        <td>
            <input type="text"
                   value="${data.landline}"
                   style="width:155px!important;"
                   onchange="updateLandline(${data.id}, this)">
        </td>
        <td>
            <button class="button"
                    onclick="updateLandline(${data.id}, this)">
                Update
            </button>
        </td>
        <td>
            <button class="button"
                    onclick="deleteLandline(${data.id})">
                Delete
            </button>
        </td>
    `;

    tbody.appendChild(row);
    blinkRowLandline(rowId);
}


function updateLandline(id, el) {
    const row = document.getElementById(`landline-row-${id}`);
    const landline = row.querySelector("input").value.trim()

    row.style.backgroundColor = "#fff3cd";

    fetch("{% url 'update_landline_ajax' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({ id, landline })
    })
    .then(res => res.json())
    .then(data => {
        row.style.backgroundColor = data.success ? "#d4edda" : "#f8d7da";
        setTimeout(() => row.style.backgroundColor = "", 500);
    });
}

function deleteLandline(id) {
    if (!confirm("Delete this landline number?")) return;

    fetch("{% url 'delete_landline_ajax' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({ id })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            document.getElementById(`landline-row-${id}`).remove();
        }
    });
}

function blinkRowLandline(id) {
    const row = document.getElementById(id);
    row.style.backgroundColor = "#ffaf53ff";
    setTimeout(() => row.style.backgroundColor = "", 600);
}

</script>

{% if not related_contact %}
<div style="margin-top: 20px;" class="body-section">
    <div id="rc" class="section-header" {% if current_con_instance and current_con_instance.skiptraced == True %}style="background-color: #bce376; color: #101010;"{% endif %}>
        <h4>Related Contacts</h4>
    </div>
    <div class="section-body-full">
        <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>SN</th>
                <th>Prefix</th>
                <th>First Name</th>
                <th>Middle Name</th>
                <th>Last Name</th>
                <th>Suffix</th>
                <th>Mailing Addresses</th>
                <th>Add / Edit</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody>
            {% for related_contact in all_related_contact %}
            <tr>
                <form method="post" action="{% url 'skiptrace_related_contact' %}">
                    {%csrf_token%}
                    <input type="hidden" name="con_id" value="{{ related_contact.id }}">
                    <input type="hidden" name="related_contact" value="{{ current_con_instance.pk }}">
                    <td>{{ forloop.counter }}</td>
                    <td>{{related_contact.name_prefix}}</td>
                    <td>{{related_contact.first_name}}</td>
                    <td>{{related_contact.middle_name}}</td>
                    <td>{{related_contact.last_name}}</td>
                    <td>{{related_contact.name_suffix}}</td>                   
                    <td>
                        {% for property in related_contact.mailing_address.all %}
                        {{ property }}<br>
                        {% endfor %}
                    </td>
                    <td><input type="submit" name="skiptrace" {% if related_contact.skiptraced == False %}style="background-color: #fe8420;" value="Skiptrace"{% endif %} value="Edit"></td>
                    <td><input type="submit" name="delete" value="Delete" ></td>
                </form>
            </tr>
            {% endfor %}
            <tr style="background-color: #fff;">
                <form id="search-form" method="post" action="{% url 'create_related_contact' %}">
                    {% csrf_token %}
                    <input type="hidden" name="con_id" value="{{ current_con_instance.pk }}">
                    <input type="hidden" name="related_contact" value="{{ related_contact }}">
                    <td></td>
                    <td><input style="width: 70px; border: 2px solid #08c88e; background-color: #54ff001f" type="text" id="rc_prefix" placeholder="Prefix" name="rc_prefix"></td>
                    <td><input style="width: 150px; border: 2px solid #08c88e; background-color: #54ff001f" type="text" id="rc_first" placeholder="First Name (ctrl+r)" name="rc_first"></td>
                    <td><input style="width: 150px; border: 2px solid #08c88e; background-color: #54ff001f" type="text" id="rc_middle" placeholder="Middle Name" name="rc_middle"></td>
                    <td><input style="width: 150px; border: 2px solid #08c88e; background-color: #54ff001f" type="text" id="rc_last" placeholder="Last Name" name="rc_last"></td>
                    <td><input style="width: 70px; border: 2px solid #08c88e; background-color: #54ff001f" type="text" id="rc_suffix" placeholder="Suffix" name="rc_suffix"></td>                  
                    <td><input style="width: 500px; border: 2px solid #08c88e; background-color: #54ff001f"type="text" id="search_query" placeholder="Search by name, business, or other details"></td>
                    <td colspan="2"><input style="border: 2px solid #08c88e;" type="submit" value="Create"></td>
                </form>
            </tr>
        </tbody>
        <tbody id="rc-results">
        </tbody>
        </table>
    </div>
</div>
<script>
    $(document).ready(function () {
        // Function to fetch and update search results
        function rcresults() {
            const rc_prefix = $('#rc_prefix').val();
            const rc_first = $('#rc_first').val();
            const rc_middle = $('#rc_middle').val();
            const rc_last = $('#rc_last').val();
            const rc_suffix = $('#rc_suffix').val();
            const search_query = $('#search_query').val();
            

            $.ajax({
                url: "{% url 'filter_related_contact' %}",
                data: {
                    rc_prefix: rc_prefix,
                    rc_first: rc_first,
                    rc_middle: rc_middle,
                    rc_last: rc_last,
                    rc_suffix: rc_suffix,
                    search_query: search_query,
                    
                },
                success: function (data) {
                    const contact = data.rc_contact;
                    const conresultcontainer = $('#rc-results');
                    conresultcontainer.empty();

                    if (contact.length > 0) {
                        contact.forEach(contact => {
                            let mailingAddressesHtml = '';
                            if (contact.mailing_addresses.length > 0) {
                                mailingAddressesHtml = contact.mailing_addresses.join('<br>'); // Join addresses with <br> for display
                            } else {
                                mailingAddressesHtml = 'No Mailing Address';
                            }
                            conresultcontainer.append(`
                            <tr>
                                <td colspan="4">${contact.name_prefix} ${contact.first_name} ${contact.middle_name} ${contact.last_name} ${contact.name_suffix}<br><small>${contact.business_name}</small></td>
                                <td colspan="3">${mailingAddressesHtml}</td>
                                <td colspan="2">
                                    <form method="post" action="{% url 'add_related_contact' %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="con_id" value="{{ current_con_instance.pk }}">
                                        <input type="hidden" name="related_contact" value="{{ related_contact }}">
                                        <input type="hidden" name="add_rc_id" value="${contact.id}">
                                        <input type="submit" value="Add">
                                    </form>
                                </td>
                            </tr>

                            `);
                        });
                    } else {
                        conresultcontainer.append('<tr><th colspan="9"><center>No Contact Record found</center></th></tr>');
                    }
                }
            });
        }
        // Trigger AJAX call on input change
        $('#rc_prefix, #rc_first, #rc_middle, #rc_last, #rc_suffix, #search_query').on('input', rcresults);
    });
</script>
{% endif %}
<div style="margin-top: 20px; float:right; display=block;" class="body-section">

    <form  method="post" action="{% url 'mark_as_skiptraced' %}" style="display:inline-block;">
        {% csrf_token %}
        <input type="hidden" name="con_id" value="{{ current_con_instance.pk }}">
        <input type="hidden" name="related_contact" value="{{ related_contact }}">
        <input id="mark-as-skiptraced" type="submit" {% if not related_contact == "" %}style="background-color: #fe8420; color: #101010;" value="Mark Related as Skiptraced (ctrl+m)"{% else %}style="background-color: #b1cc16; color: #101010;" value="Mark as Skiptraced (ctrl+m)"{% endif %}>
    </form>
</div>
<script src="{% static 'js/Surplusindex.js' %}"></script>
<script>
document.addEventListener("keydown", function(e) {
    if (e.ctrlKey && e.key.toLowerCase() === "m") {
        e.preventDefault();  // â›” blocks browser save dialog
        e.stopPropagation(); // optional but safer
        document.getElementById("mark-as-skiptraced").click();
    }
    // ctrl+e to focus on email section
    if (e.ctrlKey && e.key.toLowerCase() === "e") {
        e.preventDefault(); // optional if you want to block browser find dialog
        e.stopPropagation(); // optional but safer
        document.getElementById("email-input").focus();
    }
    // ctrl+w to focus on wireless section
    if (e.ctrlKey && e.key.toLowerCase() === "p") {
        e.preventDefault(); // optional if you want to block browser find dialog
        e.stopPropagation(); // optional but safer
        document.getElementById("wireless-input").focus();
    }
    // ctrl+l to focus on landline section
    if (e.ctrlKey && e.key.toLowerCase() === "l") {
        e.preventDefault(); // optional if you want to block browser find dialog
        e.stopPropagation(); // optional but safer
        document.getElementById("landline-input").focus();
    }
    // ctrl+r to focus on related contact section
    if (e.ctrlKey && e.key.toLowerCase() === "r") {
        e.preventDefault(); // optional if you want to block browser find dialog
        e.stopPropagation(); // optional but safer
        document.getElementById("rc_first").focus();
    }
});
</script>
{% endblock content %}