{% extends 'base.html' %}
{% block title %}
Preview Data
{% endblock title %}

{% block content %}
{% load static %}
{% load custom_filters %}

<link href="{% static 'css/surplusindex.css' %}" rel="stylesheet">
<link href="{% static 'css/client.css' %}" rel="stylesheet">

<div class="body-section">
    <div class="client-sec-header" style="margin-top:0px;">
        <h4>Data Preview for {{UID}}: {{SelectedUpload.name}} - {{ SelectedUpload.data.all.count }}</h4>
        <div>
            <form method="POST" action="{% url 'upload-file' %}" enctype="multipart/form-data" class="inline-form">
            {% csrf_token %}
                <input type="hidden" value="{{SelectedUpload.id}}" name="UID">
                <input type="file" name="file" required>
                <input type="submit" value="Upload File">
            </form>
        </div>
    </div>
    <div class="section-body-full">
        <div class="onefourth">
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="UID" value="{{SelectedUpload.id}}">
                <input type="hidden" name="update_type" value="{{update_type}}" >
                <select name="update_status" onchange="this.form.submit()" style="width:100%;">
                    <option value="">Select Update Status</option>
                    <option value="created" {% if update_status == "created" %}selected{% endif %}>Pending</option>
                    <option value="updated" {% if update_status == "updated" %}selected{% endif %}>Updated</option>
                </select>
            </form>
        </div>
        <div class="onefourth">
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="UID" value="{{SelectedUpload.id}}">
                <input type="hidden" name="update_status" value="{{update_status}}">
                <select name="update_type" onchange="this.form.submit()" style="width:100%;">
                    <option value="">Select Data Type</option>
                    <option value="new" {% if update_type == "new" %}selected{% endif %}>New</option>
                    <option value="exist" {% if update_type == "exist" %}selected{% endif %}>Existing</option>
                </select>
            </form>
        </div>
    </div>
    <div class="table-wrapper" style="max-height:600px;">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>State</th>
                    <th>County</th>
                    <th>Case Number</th>
                    <th>Sale Date</th>
                    <th>Sale Type</th>
                    <th>Appraised Value</th>
                    <th>Judgment</th>
                    <th>Sale Price</th>
                    <th>Possible Surplus</th>
                    <th>Verified Surplus</th>
                    <th>Sale Status</th>
                    <th>Surplus Status</th>
                    <th>Notes</th>
                    <th>Source</th>
                    <th></th>
                    <th>Property Address</th>
                    <th>Plaintiff</th>
                    <th>Defendants</th>
                    <th>
                    {% if update_type == "new" %}
                        <input type="submit" class="button" onclick="Upload_CUF({{SelectedUpload.id}}, 'create', 'bulk', event, this)" value="Create All">
                    {% elif update_type == "exist" %}
                        <input type="submit" class="button" onclick="Upload_CUF({{SelectedUpload.id}}, 'update', 'bulk', event, this)" value="Update All">
                    {% endif %}
                    </th>

                </tr>
            </thead>
            <tbody>
            {% for d in data_qs %}
                <tr {% if d.s_foreclosure.all.count > 0 %}style="border:3px solid #cd0a0a!important;"{% endif %}>
                    <td>{{d.state}}</td>
                    <td>{{d.county}}</td>
                    <td>{{d.case_number}}{% if d.case_number_ext %} {{d.case_number_ext}}{% endif %}</td>
                    <td>{{d.sale_date|date:"m/d/Y"}}</td>
                    <td>{{d.get_sale_type_display}}</td>
                    <td>{{d.appraised_value}}</td>
                    <td>{{d.fcl_final_judgment}}</td>
                    <td>{{d.sale_price}}</td>
                    <td>{{d.possible_surplus}}</td>
                    <td>{{d.verified_surplus}}</td>
                    <td>{{d.get_sale_status_display}}</td>
                    <td>{{d.get_surplus_status_display}}</td>
                    <td>{{d.notes}}</td>
                    <td>{{d.auction_source}}</td>
                    <td></td>
                    <td class="address-preview">
                        <div class="main-address">
                            {{ d.full_address }}
                        </div>

                        <div class="property-list">
                            {% for addr in d.s_property.all %}
                                <label class="property-row">
                                    <input type="checkbox" onchange="markInstance(this, 'Property', 'u_property', {{ addr.id }}, {{ d.id }})"
                                    {% if addr in d.u_property.all %}
                                    checked
                                    {% endif %}>
                                    <span class="property-text">{{ addr }}</span>
                                </label>
                            {% endfor %}
                        </div>
                    </td>
                    <td class="address-preview">
                        <div class="main-address">
                            {{ d.plaintiff }}
                        </div>

                        <div class="property-list">
                            {% for plt in d.s_plaintiff.all %}
                                <label class="property-row">
                                    <input type="checkbox" onchange="markInstance(this, 'ForeclosingEntity', 'u_plaintiff', {{ plt.id }}, {{ d.id }})"{% if plt in d.u_plaintiff.all %}checked{% endif %}>
                                    <span class="property-text">{{ plt }}</span>
                                </label>
                            {% endfor %}
                        </div>
                    </td>
                    <td class="address-preview">
                        <div class="main-address">
                            {{ d.full_defendant }}
                        </div>

                        <div class="property-list">
                            {% for def in d.s_defendant.all %}
                                <label class="property-row">
                                    <input type="checkbox" onchange="markInstance(this, 'Contact', 'u_defendant', {{ def.id }}, {{ d.id }})"{% if def in d.u_defendant.all %}checked{% endif %}>
                                    <span class="property-text">{{ def }}</span>
                                </label>
                            {% endfor %}
                        </div>
                    </td>
                    <td>
                    {% if d.s_foreclosure.all.count < 1 %}
                        <input type="submit" class="button" onclick="Upload_CUF({{d.id}}, 'create', 'single', event, this)"{% if d.update_status == "updated" %}value="Created" disabled{% else %}value="Create"{% endif %}>
                    {% endif %}
                    </td>



                    {% comment %} <td>
                        <form method="POST" action="{% url 'preview-data' %}">
                        {% csrf_token %}
                            <input type="hidden" value="{{u.id}}" name="UID">
                            <input type="submit" value="Preview" class="button">
                        </form>
                    </td> {% endcomment %}
                </tr>
                {% for fcl in d.s_foreclosure.all %}
                <tr style="border:3px solid #b4e249ff!important;">
                    <td style="background-color:#e3ffa3ff;">{{fcl.state}}</td>
                    <td style="background-color:#e3ffa3ff;">{{fcl.county}}</td>
                    <td style="background-color:#e3ffa3ff;">{{fcl.case_number}}{% if fcl.case_number_ext %} {{fcl.case_number_ext}}{% endif %}</td>
                    <td style="background-color:#e3ffa3ff;">{{fcl.sale_date|date:"m/d/Y"}}</td>
                    <td style="background-color:#e3ffa3ff;">{{fcl.get_sale_type_display}}</td>
                    <td style="background-color:#e3ffa3ff;">{{fcl.appraised_value}}</td>
                    <td style="background-color:#e3ffa3ff;">{{fcl.fcl_final_judgment}}</td>
                    <td style="background-color:#e3ffa3ff;">{{fcl.sale_price}}</td>
                    <td style="background-color:#e3ffa3ff;">{{fcl.possible_surplus}}</td>
                    <td style="background-color:#e3ffa3ff;">{{fcl.verified_surplus}}</td>
                    <td style="background-color:#e3ffa3ff;">{{fcl.get_sale_status_display}}</td>
                    <td style="background-color:#e3ffa3ff;">{{fcl.get_surplus_status_display}}</td>
                    <td style="background-color:#e3ffa3ff;">{{fcl.notes}}</td>
                    <td style="background-color:#e3ffa3ff;">{{fcl.auction_source}}</td>
                    <td style="background-color:#e3ffa3ff;"></td>
                    <td style="background-color:#e3ffa3ff;">{% for prop in fcl.property.all %}{{prop}}</br>{% endfor %}</td>
                    <td style="background-color:#e3ffa3ff;">{% for plt in fcl.plaintiff.all %}{{plt}}</br>{% endfor %}</td>
                    <td style="background-color:#e3ffa3ff;">{% for def in fcl.defendant.all %}{{def}}</br>{% endfor %}</td>
                    <td style="background-color:#e3ffa3ff;"><input type="submit" class="button" onclick="Upload_CUF({{d.id}}, 'update', 'single', event, this)" value="Update"></td>
                </tr>
                {% endfor %}
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<script src="{% static 'js/Client.js' %}"></script>
<script src="{% static 'js/Surplusindex.js' %}"></script>
<script src="{% static 'js/ProjectManager.js' %}"></script>
{% endblock content %}