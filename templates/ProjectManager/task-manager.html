{% extends 'base.html' %}
{% block title %}
Task Manager
{% endblock title %}

{% block content %}
{% load static %}
{% load custom_filters %}
<link href="{% static 'css/surplusindex.css' %}" rel="stylesheet">
<h1>Task Manager</h1>
<div class="section-body-full">
    <div class="section-header">
    <h4>Task Loader by Project</h4>
    <form method="POST">
    {% csrf_token %}
        <select id="project" name="project" onchange="this.form.submit()" style="width:100%;">
            <option value="">Select Project</option>
            {% for project in projects %}
            <option value="{{project.id}}" {% if selected_project == project.id %}selected{% endif %}>{{project.name|upper}}</option>
            {% endfor %}
        </select>
    </form>
</div>
{% if selected_project and selected_project != "" %}
<div class="section-body-full">
    {% if selected_task %}
    <div>
        <form method="POST">
        {% csrf_token %}
        <input type="hidden" value="{{selected_project}}" name="project">
        <button type="submit" style="float:right; border: none;"><i class="bi bi-x-circle-fill" style="color: #ad0505ff"></i></button>
        </form>
    </div>
    {% endif %}
    <form method="POST" action="{% url 'create-update-task-loader' %}">
    {% csrf_token %}
    
        <input type="hidden" name="project" value="{{project_instance.id}}">
        {% if selected_task %}
        <input type="hidden" name="task" value="{{selected_task}}">
        {% endif %}
        <div class="onethird">
            <label>Task Info & Settings</label>
            <input type="text" name="task_name" placeholder="Task Name" style="width:95%" {% if selected_task %}value="{{task_instance.task_name}}"{% endif %}>
            <select name="weekday" style="width:95%;">
                <option value="">Select Weekday</option>
                <option value="1" {% if task_instance.weekday == "1" %}selected{% endif %}>1 : Monday</option>
                <option value="2" {% if task_instance.weekday == "2" %}selected{% endif %}>2 : Tuesday</option>
                <option value="3" {% if task_instance.weekday == "3" %}selected{% endif %}>3: Wednesday</option>
                <option value="4" {% if task_instance.weekday == "4" %}selected{% endif %}>4: Thursday</option>
                <option value="5" {% if task_instance.weekday == "5" %}selected{% endif %}>5: Friday</option>
                <option value="6" {% if task_instance.weekday == "6" %}selected{% endif %}>6: Saturday</option>
                <option value="7" {% if task_instance.weekday == "7" %}selected{% endif %}>7: Sunday</option>
            </select>
            <select name="task_duration" style="width:95%;">
                <option value="">Select Task Duration</option>
                <option value="1" {% if task_instance.task_duration == 1 %}selected{% endif %}>1</option>
                <option value="2" {% if task_instance.task_duration == 2 %}selected{% endif %}>2</option>
                <option value="3" {% if task_instance.task_duration == 3 %}selected{% endif %}>3</option>
                <option value="4" {% if task_instance.task_duration == 4 %}selected{% endif %}>4</option>
                <option value="5" {% if task_instance.task_duration == 5 %}selected{% endif %}>5</option>
                <option value="6" {% if task_instance.task_duration == 6 %}selected{% endif %}>6</option>
            </select>
            <select name="task_group" style="width:95%;">
                <option value="">Select Task Group</option>
                <option value="datask" {% if task_instance.task_group == "datask" %}selected{% endif %}>Data Entry</option>
                <option value="admintask" {% if task_instance.task_group == "admintask" %}selected{% endif %}>Admin</option>
            </select>
        </div>
        
        <div class="onethird">
            <label for="assigned_to">DA Allocation</label>
            <select name="assigned_to" style="width:95%; height:132px; text-align:center; border-radius:5px; overflow:auto; padding:10px;" multiple>
                <optgroup label="Admins">
                {% for admin in admin_list %}
                <option value="{{admin.username}}"{% if selected_task and admin in task_instance.assigned_to.all %}selected{% endif %}>{{admin.username|upper}}</option>
                {% endfor %}
                <optgroup label="Data Analysts">
                {% for da in da_list %}
                <option value="{{da.username}}" {% if selected_task and da in task_instance.assigned_to.all %}selected{% endif %}>{{da.username|upper}}</option>
                {% endfor %}
                
            </select>
        </div>
        <div class="onethird">
            <label for="job_description">Job Description</label>
            <textarea name="job_description" style="width:100%; height:132px; text-align:center; float:right; border-radius:5px;" placeholder="Enter Job Description Here...">{% if selected_task %}{{task_instance.job_detail}}{% endif %}</textarea>
            <input type="submit" value="{% if selected_task %}Update Task Template Instance{% else %}Create Task Instance for {{project_instance.name}}{% endif %}" style="width:94%; margin-top:10px;">
        </div>
    </form>
</div>
<div class="table-wrapper">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Project</th>
                <th>WeekDay</th>
                <th>Task Name</th>
                <th>Task Group</th>
                <th>Assigned To</th>
                <th>Active</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        {% for task in taskloader %}
            <tr>
                <td>{{task.project.name}}</td>
                <td>{{task.weekday}}</td>
                <td>{{task.task_name}}</td>
                <td>{{task.task_group}}</td>
                <td>{% for user in task.assigned_to.all %}{{user.username|upper}}{% if not forloop.last %}, {% endif %}{% endfor %}</td>
                <td>{% if task.archived == True %}<i class="bi bi-x-circle-fill" style="color:red;"></i>{% else %}<i class="bi bi-check-circle-fill" style="color:green;"></i>{% endif %}</td>
                <td>
                <form method="POST">
                {% csrf_token %}
                    <input type="hidden" name="project" value="{{ selected_project }}">
                    <input type="hidden" name="task" value="{{ task.id }}">
                    <input type="submit" value="Edit" class="button">
                </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
    
{% endif %}



<script src="{% static 'js/ProjectManager.js' %}"></script>
<script src="{% static 'js/Surplusindex.js' %}"></script>
{% endblock content %}