{% extends 'base.html' %}
{% block title %}Auction Calendar Settings{% endblock title %}

{% block content%}
{% load static %}
<link href="{% static 'css/surplusindex.css' %}" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<div class="section-header">
    <h4>Auction Calendar Settings</h4>
    <div>
        <a class="button button-small" href="{% url 'upload_calendar_data' %}">Upload Calendar Data</a>
        <a class="button button-small" href="{% url 'export_data' %}">Export Calendar Data</a>
    </div>
</div>
<div class="section-filter-full">
</div>



<div class="section-header" style="margin-top:20px;">
    <h4>{% if EventInstance %}Update Event | {{EventInstance.state}} - {{EventInstance.county}}{% else %}Create New Event{% endif %}</h4>
    <a class="button button-small" href="{% url 'calendar_settings' %}">Clear</a>
</div>

<div class="section-body-full">
<form method="post" action="{% url 'create_update_events' %}">
{% csrf_token %}
    <input type="hidden" name="selectedevent" value={{EventInstance.pk}}>
    <div class="onehalf header-text">
        <h4>Event Detail</h4>
        <div class="form-row">
            <label for="state">State</label>
            <input type="text" name="state" placeholder="State" id="state" {% if EventInstance %}value="{{EventInstance.state}}"{% endif %}>
        </div>
        <div class="form-row">
            <label for="county">County</label>
            <input type="text" name="county" placeholder="County" id="county" {% if EventInstance %}value="{{EventInstance.county}}"{% endif %}>
        </div>
        <div class="form-row">
            <label for="saletype">Sale Type</label>
            <select name="saletype" id="sale_type">
                <option value="">Select Sale Type</option>
                <option value="TAX" {% if EventInstance.sale_type == "TAX" %}selected{% endif %}>TAX</option>
                <option value="MORTGAGE" {% if EventInstance.sale_type == "MORTGAGE" %}selected{% endif %}>MORTGAGE</option>
                <option value="TAX & MORTGAGE" {% if EventInstance.sale_type == "TAX & MORTGAGE" %}selected{% endif %}>TAX & MORTGAGE</option>
                <option value="OTHERS" {% if EventInstance.sale_type == "OTHERS" %}selected{% endif %}>OTHERS</option>
            </select>
        </div>
        <div class="form-row">
            <label for="population">Population</label>
            <input type="text" name="population" placeholder="Population" {% if EventInstance %}value="{{EventInstance.population}}"{% endif %}>
        </div>
        <div class="form-row">
            <label for="status">Event Status</label>
            <select name="status">
                <option value="" {% if EventInstance.event_status == "" %}selected{% endif %}>Select Event Status</option>
                <option value="Running" {% if EventInstance.event_status == "Running" %}selected{% endif %}>Running</option>
                <option value="Hold" {% if EventInstance.event_status == "Hold" %}selected{% endif %}>Hold</option>
            </select>
        </div>
        {% if EventInstance %}
        <div class="form-row">
            <label for="assignedto">Assigned</label>
            <select name="assignedto">
                <option value=""{% if EventInstance.assigned_to == None %}selected{% endif %}>Select an Analyst</option>
                {% for user in Users %}
                <option value="{{user.id}}" {% if EventInstance.assigned_to == user %}selected{% endif %}>{{user.username|upper}}</option>
                {% endfor %}
            </select>
        </div>
    
        <h4>Pre-Foreclosure Dates</h4>
        <div class="form-row">
            <label for="updatedfrom">Updated From</label>
            <input type="date" name="updatedfrom" {% if EventInstance %}value="{{EventInstance.event_updated_from|date:'Y-m-d'}}"{% endif %}>
        </div>
        <div class="form-row">
            <label for="updatedto">Updated To</label>
            <input type="date" name="updatedto" {% if EventInstance %}value="{{EventInstance.event_updated_to|date:'Y-m-d'}}"{% endif %}>
        </div>
        <div class="form-row">
            <label for="eventnext">Next Sale</label>
            <input type="date" name="eventnext" {% if EventInstance %}value="{{EventInstance.event_next|date:'Y-m-d'}}"{% endif %}>
        </div>
        <h4>Post-Foreclosure Dates</h4>
        <div class="form-row">
            <label for="post_updatedfrom">Updated From</label>
            <input type="date" name="post_updatedfrom" {% if EventInstance %}value="{{EventInstance.post_event_updated_from|date:'Y-m-d'}}"{% endif %}>
        </div>
        <div class="form-row">
            <label for="post_updatedto">Updated To</label>
            <input type="date" name="post_updatedto" {% if EventInstance %}value="{{EventInstance.post_event_updated_to|date:'Y-m-d'}}"{% endif %}>
        </div>
        <div class="form-row">
            <label for="post_eventnext">Next Sale</label>
            <input type="date" name="post_eventnext" {% if EventInstance %}value="{{EventInstance.post_event_next|date:'Y-m-d'}}"{% endif %}>
        </div>
    </div>
    <div class="onehalf header-text">
        <h4>Foreclosure Links</h4>
        <div class="form-row">
            <label for="eventlink">Auction</label>
            <input type="text" name="eventlink" placeholder="Event Link"  {% if EventInstance %}value="{{EventInstance.event_site}}"{% endif %}>
        </div>
        <div class="form-row">
            <label for="caselink">Case Portal</label>
            <input type="text" name="caselink" placeholder="Case Search Link" {% if EventInstance %}value="{{EventInstance.event_case_search}}"{% endif %}>
        </div>
        <div class="form-row">
            <label for="public_notice">Public Notice</label>
            <input type="text" name="public_notice" placeholder="Public Notice" {% if EventInstance %}value="{{EventInstance.public_notice}}"{% endif %}>
        </div>

        <h4>Property Records</h4>
        <div class="form-row">
            <label for="recorder">Recorder</label>
            <input type="text" name="recorder" placeholder="Recorder" {% if EventInstance %}value="{{EventInstance.recorder}}"{% endif %}>
        </div>

        <div class="form-row">
            <label for="assessor">Assessor</label>
            <input type="text" name="assessor" placeholder="Assessor" {% if EventInstance %}value="{{EventInstance.assessor}}"{% endif %}>
        </div>
        <div class="form-row">
            <label for="tax_collector">Tax Collector</label>
            <input type="text" name="tax_collector" placeholder="Tax Collector" {% if EventInstance %}value="{{EventInstance.tax_collector}}"{% endif %}>
        </div>
        <div class="form-row">
            <label for="gis">GIS Map</label>
            <input type="text" name="gis" placeholder="GIS Map" {% if EventInstance %}value="{{EventInstance.gis}}"{% endif %}>
        </div>
        <h4>Court Records</h4>
        <div class="form-row">
            <label for="district">District Court</label>
            <input type="text" name="district" placeholder="District Court" {% if EventInstance %}value="{{EventInstance.district}}"{% endif %}>
        </div>
        <div class="form-row">
            <label for="civil">Civil Court</label>
            <input type="text" name="civil" placeholder="Civil Court" {% if EventInstance %}value="{{EventInstance.civil}}"{% endif %}>
        </div>
        <div class="form-row">
            <label for="municipal">Municipal Court</label>
            <input type="text" name="municipal" placeholder="Municipal Court" {% if EventInstance %}value="{{EventInstance.municipal}}"{% endif %}>
        </div>
        <div class="form-row">
            <label for="probate">Probate Court</label>
            <input type="text" name="probate" placeholder="Probate Court" {% if EventInstance %}value="{{EventInstance.probate}}"{% endif %}>
        </div>
        <div class="form-row">
            <label for="superior">Superior Court</label>
            <input type="text" name="superior" placeholder="Superior Court" {% if EventInstance %}value="{{EventInstance.superior}}"{% endif %}>
        </div>
        <div class="form-row">
            <label for="supreme">Supreme Court</label>
            <input type="text" name="supreme" placeholder="Supreme Court" {% if EventInstance %}value="{{EventInstance.supreme}}"{% endif %}>
        </div>
        <div class="form-row">
            <label for="surrogate">Surrogate Court</label>
            <input type="text" name="surrogate" placeholder="Surrogate Court" {% if EventInstance %}value="{{EventInstance.surrogate}}"{% endif %}>
        </div>
    </div>
    

    {% endif %}
    <input type="submit" class="button" value="{% if EventInstance %}Update Event{% else %}Create Event{% endif %}">
</form>
<table class="table table-striped table-hover" style="margin-top:30px;">
    <thead>
        <tr>
            <th>State</th>
            <th>County</th>
            <th>Population</th>
            <th>Sale Type</th>
            <th>Event Status</th>
            <th>Edit</th>
            <th>Delete</th>
        </tr>
    </thead>
    <tbody id="EventResults">
    </tbody>
</table>
</div>
<script>
    $(document).ready(function () {
        // Function to fetch and update search results
        function fetchevents() {
            const State = $('#state').val();
            const County = $('#county').val();
            const SaleType = $('#sale_type').val();
            

            $.ajax({
                url: "{% url 'filterevents' %}",
                data: {
                    state: State,
                    county: County,
                    sale_type: SaleType,

                },
                success: function (data) {
                    const events = data.Events;
                    const eventresultsContainer = $('#EventResults');

                    eventresultsContainer.empty();

                    if (events.length > 0) {
                        events.forEach(eventdata => {
                            eventresultsContainer.append(`

                            <tr id="${eventdata.id}">
                                <td>${eventdata.state}</td>
                                <td>${eventdata.county}</td>
                                <td>${eventdata.population}</td>
                                <td>${eventdata.sale_type}</td>
                                <td>${eventdata.event_status}</td>
                                <td>
                                    <form method="post" action="{% url 'calendar_settings'%}">
                                    {% csrf_token %}
                                        <input type="hidden" name="selectedevent" value="${eventdata.id}">
                                        <input type="submit" value="Edit" onclick="this.form.submit()">
                                    </form>
                                </td>
                                <td><button class="button" onclick="deleteEvent('${eventdata.id}')"><i class="bi bi-trash3"></i></button></td>
                            </tr>
                            
                                `);
                        });
                    } else {
                        eventresultsContainer.append('<tr><th colspan="7"><center>No Events Record Found!</center></th></tr>');
                    }
                }
            });
        }

        // Trigger AJAX call on input change
        $('#state, #county, #sale_type').on('input', fetchevents);
    });
</script>


<script src="{% static 'js/auction_calendar.js' %}"></script>

{% endblock content%}