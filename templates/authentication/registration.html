{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="{% static 'css/homepage.css' %}" rel="stylesheet">
    <title>SurplusIndex | Registration</title>
</head>
<body>
<script src="https://js.stripe.com/v3/"></script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-VSCGX4BF1W"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-VSCGX4BF1W');
</script>
<div class="container">

    <div class="left-section">
        <div>
            <h1>SurplusIndex</h1>
            <p>The Largest Surplus Funds Database Tailored for Recovery Agents</p>
        </div>
    </div>

    <div class="right-section">
        <div class="login-box">
            <h2>Create Account</h2>
            <div id="invalid_user" class="error-msg"></div>
            <div id="invalid_email" class="error-msg"></div>
            <div id="invalid_password" class="error-msg"></div>
            {% include 'partials/_messages.html' %}
            <!-- STEP 1 -->
            <div id="step1">           
                <input type="text" id="username" placeholder="Username" required>
                <input type="email" id="email" placeholder="Email" required>
                <div class="input-group">
                    <input type="password" id="password" placeholder="Password" required>
                    <span class="toggle-password" onclick="togglePassword()">
                        üëÅ
                    </span>
                </div>
                <button id="nextBtn" disabled>Next</button>
            </div>
            <!-- STEP 2 -->
            <div id="step2" style="display:none;">
                <div id="payment-element"></div>
                <button id="finishBtn">Finish Setup</button>
            </div>

            

        </div>
    </div>

</div>

<script>
function togglePassword() {
    const passwordField = document.getElementById("password");
    const toggleIcon = document.querySelector(".toggle-password");

    if (passwordField.type === "password") {
        passwordField.type = "text";
        toggleIcon.textContent = "üëì";
    } else {
        passwordField.type = "password";
        toggleIcon.textContent = "üëÅ";
    }
}
</script>

<script>
const stripe = Stripe("{{ STRIPE_PUBLIC_KEY }}");
let elements;

document.getElementById("nextBtn").addEventListener("click", async () => {

    const response = await fetch("/register/start/", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            username: username.value,
            email: email.value,
            password: password.value
        })
    });

    const data = await response.json();

    elements = stripe.elements({ clientSecret: data.clientSecret });
    const paymentElement = elements.create("payment");
    paymentElement.mount("#payment-element");

    document.getElementById("step1").style.display = "none";
    document.getElementById("step2").style.display = "block";
});


document.getElementById("finishBtn").addEventListener("click", async () => {

    const { setupIntent, error } = await stripe.confirmSetup({
        elements,
        redirect: "if_required"
    });

    if (error) {
        alert(error.message);
        return;
    }

    if (setupIntent.status === "succeeded") {

        const response = await fetch("/register/complete/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            credentials: "same-origin",
            body: JSON.stringify({})
        });

        const data = await response.json();
        console.log("Complete response:", data);

        if (data.status === "success") {
            window.location.href = "/dashboard/";
        } else {
            alert(data.error || "Registration failed");
        }
    }
});
</script>
<script src="{% static 'js/register.js' %}"></script>
{% comment %} 

    <div style="display:block">
        <div class="blank-left">
            <center>
                <h1>SurplusIndex</h1>
                <h5>The Largest Surplus Funds Database</br>Tailored for Recovery Agents</h5></br>
            </center>
        </div>
        <div class="option-right">
            <center>
                <div class="card card-large">
                    <a href="{% url 'login' %}" class="button button-large" role="button">Log In</a>
                    <a href="{% url 'register' %}" class="button button-large" role="button">Create an Account</a>
                </div>
            </center>
        </div>
    </div> 
</body>

</html>
{% endcomment %}

{% comment %}
{% extends 'base_auth.html' %}
{% block title %}Register{% endblock %}
{% load static %}
{% block content %}



<div class="card card-large">
    <h2>Register</h2>
    <form method="POST" action="{% url 'create_checkout_session' %}">
    {% csrf_token %}
    
    <input type="email" name="email" required>
    <input type="password" name="password" required>
    
    <h4>Select Plan</h4>
    
    <input type="radio" name="plan" value="starter" required> $29 - 50 Credits
    <input type="radio" name="plan" value="growth"> $59 - 120 Credits
    <input type="radio" name="plan" value="pro"> $99 - 250 Credits
    
    <button type="submit">Subscribe & Create Account</button>
    </form>
    <form action="" method="post">
        {% csrf_token %}
        {% include 'partials/_messages.html' %}

        <input type="text" name="username" id="usernameField" placeholder="User Name" value="{{fieldValues.username}}">
        <div class="invalid_feedback invalid-feedback" style="display: none;"></div>
        <input type="email" name="email" id="emailField" placeholder="Email" value="{{fieldValues.email}}">
        <div class="emailFeedBackArea invalid-feedback" style="display: none;"></div>
        <input type="password" name="password" id="passwordField" placeholder="Password">
        
        <div class="pw-toggle">
            <small class="showPasswordToggle">SHOW</small>
        </div>
        <input type="submit" value="Register" class="button submit-btn">
    
    </form> 
</div>

<script src="{% static 'js/register.js' %}"></script>


{% endblock content %}{% endcomment %}